# advBBS docker compose
# 
# Usage:
#   ./setup.sh                            # Run setup first
#   docker compose up -d                  # Start BBS + web config
#   docker compose logs -f                # View logs
#
# Web config: http://localhost:7681
#
# Environment variables (set these to customize initial config):
#   ADVBBS_NAME          - BBS name (default: advBBS)
#   ADVBBS_CALLSIGN      - BBS callsign (default: ADVBBS)
#   ADVBBS_ADMIN_PASS    - Admin password (default: changeme)
#   TZ                   - Timezone (default: UTC)
#   ADVBBS_CONNECTION    - Connection type: serial, tcp (default: serial)
#   ADVBBS_SERIAL_PORT   - Serial port (default: /dev/ttyUSB0)
#   ADVBBS_TCP_HOST      - TCP host if using tcp connection
#   ADVBBS_TCP_PORT      - TCP port if using tcp connection (default: 4403)

services:
    advbbs:
        image: ghcr.io/zvx-echo6/advbbs:latest
        container_name: advbbs
        ports:
          - "7681:7681"
        volumes:
          - ./data:/data
        restart: unless-stopped

    # USB serial connection
    # Change this to match the address of your device
    # You should comment this out if you are connecting to the node over TCP.
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0
      
    environment:
      - advBBS_CONFIG=/data/config.toml
      - TZ=${TZ:-UTC}
      - ADVBBS_NAME=${ADVBBS_NAME:-advBBS}
      - ADVBBS_CALLSIGN=${ADVBBS_CALLSIGN:-ADVBBS}
      - ADVBBS_ADMIN_PASS=${ADVBBS_ADMIN_PASS:-changeme}
      - ADVBBS_CONNECTION=${ADVBBS_CONNECTION:-serial}
      - ADVBBS_SERIAL_PORT=${ADVBBS_SERIAL_PORT:-/dev/ttyUSB0}
      - ADVBBS_TCP_HOST=${ADVBBS_TCP_HOST:-localhost}
      - ADVBBS_TCP_PORT=${ADVBBS_TCP_PORT:-4403}
      - ADVBBS_MODE=${ADVBBS_MODE:-full}

    # Resource Limits
    # Default limits should be safe for low-powered devices. 256MB is plenty for this app.
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

    # Comment out to disable logging to a file
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; c=sqlite3.connect('/data/advbbs.db'); c.execute('SELECT 1'); c.close()"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 30s

    # This is only needed if you are connecting to the node over TCP
    # can be commented out if you are using serial (e.g. /dev/ttyUSB0)
    extra_hosts:
      - "host.docker.internal:host-gateway"
