# advBBS Docker Compose for x86/x64 Linux
#
# For desktops, servers, VMs, and other x86/x64 systems
#
# Usage:
#   ./setup.sh                            # Run setup first
#   docker compose up -d                  # Start BBS + web config
#   docker compose logs -f                # View logs
#
# Web config: http://localhost:7681

services:
  advbbs:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    image: advbbs:latest
    container_name: advbbs
    restart: unless-stopped

    # USB serial connection to Meshtastic device
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0

    ports:
      # Web-based config interface (ttyd)
      - "7681:7681"

    volumes:
      # Persistent data volume (auto-created)
      - advbbs_data:/data
      - advbbs_logs:/var/log

    environment:
      - advBBS_CONFIG=/data/config.toml
      - TZ=America/Boise

    extra_hosts:
      - "host.docker.internal:host-gateway"

    stdin_open: true
    tty: true

    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; sqlite3.connect('/data/advbbs.db').execute('SELECT 1')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  advbbs_data:
    name: advbbs_data
  advbbs_logs:
    name: advbbs_logs

networks:
  default:
    name: advbbs_network
